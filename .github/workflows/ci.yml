name: CI Pipeline

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test-backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          
      - name: Run System Audit (Dry Run)
        run: |
          python -m py_compile backend/tests/system_audit.py
          python -m py_compile backend/main.py
          python -m py_compile backend/core/config_loader.py
          python -m py_compile backend/core/orchestrator.py
          python -m py_compile backend/core/tool_factory.py
          python -m py_compile backend/tools/n8n_bridge.py
          python -m py_compile backend/tools/scraper.py
          python -m py_compile backend/tools/search.py
          python -m py_compile backend/voice_agent.py

  test-frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
          
      - name: Install Dependencies
        working-directory: ./frontend
        run: npm ci
          
      - name: Lint
        working-directory: ./frontend
        run: npm run lint
          
      - name: Build
        working-directory: ./frontend
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'http://localhost' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'dummy-key' }}

